# 广告后台服务化方案

## 背景
   商业平台业务日趋复杂，随之代码仓库日趋庞大，代码几乎全部集中在adweb和ss_ad两个仓库，随着业务的快速发展，后期代码膨胀将难以维护.
   
## 缺点
   * 不同业务全部集中在一个系统里，代码的开发、线上维护互相影响
   * 代码接口、方法通过引入模块进行依赖，模块间无法做到完全透明，不够轻量
   * 业务职能边界不够清晰，不收敛，很难做到单一职责
   
## 服务化方案
   * 系统按照不同的业务进行业务模块划分，职责收敛
   * 不同业务模块对外提供rpc服务，不再进行代码依赖，而是服务接口依赖
   * 将controller层单独抽离成一个系统模块，该模块只负责将http请求转发给后端rpc服务，以及多种rpc服务的组合，业务逻辑全部下沉到各个rpc服务

## 服务化模块
   根据现有商业平台业务功能进行划分，将分为以下八大中心，两大web系统
   
   1、八大中心
   * 推广中心：负责adgroup，campaign，creative的管理
   * 账户中心：负责广告主，代理商的操作权限，登录的管理
   * 日志中心：负责广告主操作日志管理
   * 工具中心：负责平台工具管理
   * 报表中心：负责平台报表数据管理
   * 消息中心：负责平台站内信管理
   * 库存中心：负责库存管理
   * 财务中心：负责平台财务结算管理
   
   2、两大web系统
   * 商业平台前端系统：负责http请求处理，业务数据响应，rpc服务调用，前端模板渲染
   * open api网关系统：通过配置化方式将rpc服务能力对外以http接口透出，负责open api的参数到rpc服务参数的转化，参数合法性校验，rpc服务编排
   
## 服务化架构图
![](file:///Users/liboyang/github/newgit1/lALPAAAAARPYcuTM7s0B1A_468_238.png)

## 迁移方案
   因为业务迭代的速度很快，而将现有复杂系统进行服务化拆分是一个非常耗时漫长的过程，因此迁移步骤尤为重要，步骤如下：
   
   #### 代码迁移
   
     1、先将业务最稳定模块服务化拆出，目前商业平台广告推广主流程最为稳定，如创建adgroup、campaign
     2、创建以runtime框架为基础的rpc服务工程，并规范好工程的代码规范，目录结构
     3、将adgroup和campaign的业务逻辑迁移到该工程（推广中心），提供rpc服务接口
     4、因为是新工程，尽量采用新平台支撑: 
        (1) gerrit迁移gitlab
        (2) 接入tce
        
   #### 流量迁移
   推广中心上线后，会接入线上adgroup和campaign的业务流量，即使线下测试无问题，也不能完全保证推广中心代码逻辑正确性，因此需要引入线上流量进行一段时间观察对比和验证，
   目前有三个方案：
   
   ###### 方案一
   
    1、全量copy一份线上白名单客户的adgroup和campaign数据表，称为影子表
    2、在ad_web上引入双读双写middleware，拦截所有请求，但只对白名单客户进行流量的双读双写
    3、对客户端的读写数据响应都以原接口为准
    4、middleware同时进行异步读对比，把不一致数据写日志落盘，并同步es
    4、原表与影子表数据对比，每一小时离线对比一次
    
    缺陷：存在非幂等接口或数据消费端，导致数据不一致的情况，同时对比方案略重，失去了快速迭代的灵活性
    优点：能保证读写数据的强一致性

   ###### 方案二
    1、在ad_web引入根据用户白名单进行流量切分的middleware，与方案一不同的是流量不在镜像一份，切流过程从小到大逐步验证
    2、在白名单的用户流量进入推广中心，读写都已新接口为准
    3、与老接口一样写线上库
    
    缺陷：对于被白名单而切流的客户读写数据不能及时进行对比，需要用户反馈，并人工确认，一旦数据有问题，需要人工订正，并不断修复上线，需要测试环节给力
    优点：能够快速迭代，周期短
    
    